{"ast":null,"code":"// Copyright 2010-2012 Mikeal Rogers\n//\n//    Licensed under the Apache License, Version 2.0 (the \"License\");\n//    you may not use this file except in compliance with the License.\n//    You may obtain a copy of the License at\n//\n//        http://www.apache.org/licenses/LICENSE-2.0\n//\n//    Unless required by applicable law or agreed to in writing, software\n//    distributed under the License is distributed on an \"AS IS\" BASIS,\n//    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n//    See the License for the specific language governing permissions and\n//    limitations under the License.\nvar http = require('http'),\n    https = false,\n    tls = false,\n    url = require('url'),\n    util = require('util'),\n    stream = require('stream'),\n    qs = require('qs'),\n    querystring = require('querystring'),\n    crypto = require('crypto'),\n    oauth = require('oauth-sign'),\n    hawk = require('hawk'),\n    aws = require('aws-sign'),\n    httpSignature = require('http-signature'),\n    uuid = require('node-uuid'),\n    mime = require('mime'),\n    tunnel = require('tunnel-agent'),\n    safeStringify = require('json-stringify-safe'),\n    ForeverAgent = require('forever-agent'),\n    FormData = require('form-data'),\n    Cookie = require('cookie-jar'),\n    CookieJar = Cookie.Jar,\n    cookieJar = new CookieJar();\n\ntry {\n  https = require('https');\n} catch (e) {}\n\ntry {\n  tls = require('tls');\n} catch (e) {}\n\nvar debug;\n\nif (/\\brequest\\b/.test(process.env.NODE_DEBUG)) {\n  debug = function () {\n    console.error('REQUEST %s', util.format.apply(util, arguments));\n  };\n} else {\n  debug = function () {};\n}\n\nfunction toBase64(str) {\n  return new Buffer(str || \"\", \"ascii\").toString(\"base64\");\n}\n\nfunction md5(str) {\n  return crypto.createHash('md5').update(str).digest('hex');\n} // Hacky fix for pre-0.4.4 https\n\n\nif (https && !https.Agent) {\n  https.Agent = function (options) {\n    http.Agent.call(this, options);\n  };\n\n  util.inherits(https.Agent, http.Agent);\n\n  https.Agent.prototype._getConnection = function (host, port, cb) {\n    var s = tls.connect(port, host, this.options, function () {\n      // do other checks here?\n      if (cb) cb();\n    });\n    return s;\n  };\n}\n\nfunction isReadStream(rs) {\n  if (rs.readable && rs.path && rs.mode) {\n    return true;\n  }\n}\n\nfunction copy(obj) {\n  var o = {};\n  Object.keys(obj).forEach(function (i) {\n    o[i] = obj[i];\n  });\n  return o;\n}\n\nvar isUrl = /^https?:/;\nvar globalPool = {};\n\nfunction Request(options) {\n  stream.Stream.call(this);\n  this.readable = true;\n  this.writable = true;\n\n  if (typeof options === 'string') {\n    options = {\n      uri: options\n    };\n  }\n\n  var reserved = Object.keys(Request.prototype);\n\n  for (var i in options) {\n    if (reserved.indexOf(i) === -1) {\n      this[i] = options[i];\n    } else {\n      if (typeof options[i] === 'function') {\n        delete options[i];\n      }\n    }\n  }\n\n  if (options.method) {\n    this.explicitMethod = true;\n  }\n\n  this.init(options);\n}\n\nutil.inherits(Request, stream.Stream);\n\nRequest.prototype.init = function (options) {\n  // init() contains all the code to setup the request object.\n  // the actual outgoing request is not started until start() is called\n  // this function is called from both the constructor and on redirect.\n  var self = this;\n  if (!options) options = {};\n  if (!self.method) self.method = options.method || 'GET';\n  self.localAddress = options.localAddress;\n  debug(options);\n  if (!self.pool && self.pool !== false) self.pool = globalPool;\n  self.dests = self.dests || [];\n  self.__isRequestRequest = true; // Protect against double callback\n\n  if (!self._callback && self.callback) {\n    self._callback = self.callback;\n\n    self.callback = function () {\n      if (self._callbackCalled) return; // Print a warning maybe?\n\n      self._callbackCalled = true;\n\n      self._callback.apply(self, arguments);\n    };\n\n    self.on('error', self.callback.bind());\n    self.on('complete', self.callback.bind(self, null));\n  }\n\n  if (self.url) {\n    // People use this property instead all the time so why not just support it.\n    self.uri = self.url;\n    delete self.url;\n  }\n\n  if (!self.uri) {\n    // this will throw if unhandled but is handleable when in a redirect\n    return self.emit('error', new Error(\"options.uri is a required argument\"));\n  } else {\n    if (typeof self.uri == \"string\") self.uri = url.parse(self.uri);\n  }\n\n  if (self.strictSSL === false) {\n    self.rejectUnauthorized = false;\n  }\n\n  if (self.proxy) {\n    if (typeof self.proxy == 'string') self.proxy = url.parse(self.proxy); // do the HTTP CONNECT dance using koichik/node-tunnel\n\n    if (http.globalAgent && self.uri.protocol === \"https:\") {\n      var tunnelFn = self.proxy.protocol === \"http:\" ? tunnel.httpsOverHttp : tunnel.httpsOverHttps;\n      var tunnelOptions = {\n        proxy: {\n          host: self.proxy.hostname,\n          port: +self.proxy.port,\n          proxyAuth: self.proxy.auth,\n          headers: {\n            Host: self.uri.hostname + ':' + (self.uri.port || self.uri.protocol === 'https:' ? 443 : 80)\n          }\n        },\n        rejectUnauthorized: self.rejectUnauthorized,\n        ca: this.ca\n      };\n      self.agent = tunnelFn(tunnelOptions);\n      self.tunnel = true;\n    }\n  }\n\n  if (!self.uri.host || !self.uri.pathname) {\n    // Invalid URI: it may generate lot of bad errors, like \"TypeError: Cannot call method 'indexOf' of undefined\" in CookieJar\n    // Detect and reject it as soon as possible\n    var faultyUri = url.format(self.uri);\n    var message = 'Invalid URI \"' + faultyUri + '\"';\n\n    if (Object.keys(options).length === 0) {\n      // No option ? This can be the sign of a redirect\n      // As this is a case where the user cannot do anything (he didn't call request directly with this URL)\n      // he should be warned that it can be caused by a redirection (can save some hair)\n      message += '. This can be caused by a crappy redirection.';\n    }\n\n    self.emit('error', new Error(message));\n    return; // This error was fatal\n  }\n\n  self._redirectsFollowed = self._redirectsFollowed || 0;\n  self.maxRedirects = self.maxRedirects !== undefined ? self.maxRedirects : 10;\n  self.followRedirect = self.followRedirect !== undefined ? self.followRedirect : true;\n  self.followAllRedirects = self.followAllRedirects !== undefined ? self.followAllRedirects : false;\n  if (self.followRedirect || self.followAllRedirects) self.redirects = self.redirects || [];\n  self.headers = self.headers ? copy(self.headers) : {};\n  self.setHost = false;\n\n  if (!(self.headers.host || self.headers.Host)) {\n    self.headers.host = self.uri.hostname;\n\n    if (self.uri.port) {\n      if (!(self.uri.port === 80 && self.uri.protocol === 'http:') && !(self.uri.port === 443 && self.uri.protocol === 'https:')) self.headers.host += ':' + self.uri.port;\n    }\n\n    self.setHost = true;\n  }\n\n  self.jar(self._jar || options.jar);\n\n  if (!self.uri.pathname) {\n    self.uri.pathname = '/';\n  }\n\n  if (!self.uri.port) {\n    if (self.uri.protocol == 'http:') {\n      self.uri.port = 80;\n    } else if (self.uri.protocol == 'https:') {\n      self.uri.port = 443;\n    }\n  }\n\n  if (self.proxy && !self.tunnel) {\n    self.port = self.proxy.port;\n    self.host = self.proxy.hostname;\n  } else {\n    self.port = self.uri.port;\n    self.host = self.uri.hostname;\n  }\n\n  self.clientErrorHandler = function (error) {\n    if (self._aborted) return;\n\n    if (self.req && self.req._reusedSocket && error.code === 'ECONNRESET' && self.agent.addRequestNoreuse) {\n      self.agent = {\n        addRequest: self.agent.addRequestNoreuse.bind(self.agent)\n      };\n      self.start();\n      self.req.end();\n      return;\n    }\n\n    if (self.timeout && self.timeoutTimer) {\n      clearTimeout(self.timeoutTimer);\n      self.timeoutTimer = null;\n    }\n\n    self.emit('error', error);\n  };\n\n  self._parserErrorHandler = function (error) {\n    if (this.res) {\n      if (this.res.request) {\n        this.res.request.emit('error', error);\n      } else {\n        this.res.emit('error', error);\n      }\n    } else {\n      this._httpMessage.emit('error', error);\n    }\n  };\n\n  if (options.form) {\n    self.form(options.form);\n  }\n\n  if (options.qs) self.qs(options.qs);\n\n  if (self.uri.path) {\n    self.path = self.uri.path;\n  } else {\n    self.path = self.uri.pathname + (self.uri.search || \"\");\n  }\n\n  if (self.path.length === 0) self.path = '/'; // Auth must happen last in case signing is dependent on other headers\n\n  if (options.oauth) {\n    self.oauth(options.oauth);\n  }\n\n  if (options.aws) {\n    self.aws(options.aws);\n  }\n\n  if (options.hawk) {\n    self.hawk(options.hawk);\n  }\n\n  if (options.httpSignature) {\n    self.httpSignature(options.httpSignature);\n  }\n\n  if (options.auth) {\n    self.auth(options.auth.user === \"\" ? options.auth.user : options.auth.user || options.auth.username, options.auth.pass || options.auth.password, options.auth.sendImmediately);\n  }\n\n  if (self.uri.auth && !self.headers.authorization) {\n    var authPieces = self.uri.auth.split(':').map(function (item) {\n      return querystring.unescape(item);\n    });\n    self.auth(authPieces[0], authPieces.slice(1).join(':'), true);\n  }\n\n  if (self.proxy && self.proxy.auth && !self.headers['proxy-authorization'] && !self.tunnel) {\n    self.headers['proxy-authorization'] = \"Basic \" + toBase64(self.proxy.auth.split(':').map(function (item) {\n      return querystring.unescape(item);\n    }).join(':'));\n  }\n\n  if (self.proxy && !self.tunnel) self.path = self.uri.protocol + '//' + self.uri.host + self.path;\n\n  if (options.json) {\n    self.json(options.json);\n  } else if (options.multipart) {\n    self.boundary = uuid();\n    self.multipart(options.multipart);\n  }\n\n  if (self.body) {\n    var length = 0;\n\n    if (!Buffer.isBuffer(self.body)) {\n      if (Array.isArray(self.body)) {\n        for (var i = 0; i < self.body.length; i++) {\n          length += self.body[i].length;\n        }\n      } else {\n        self.body = new Buffer(self.body);\n        length = self.body.length;\n      }\n    } else {\n      length = self.body.length;\n    }\n\n    if (length) {\n      if (!self.headers['content-length'] && !self.headers['Content-Length']) self.headers['content-length'] = length;\n    } else {\n      throw new Error('Argument error, options.body.');\n    }\n  }\n\n  var protocol = self.proxy && !self.tunnel ? self.proxy.protocol : self.uri.protocol,\n      defaultModules = {\n    'http:': http,\n    'https:': https\n  },\n      httpModules = self.httpModules || {};\n  self.httpModule = httpModules[protocol] || defaultModules[protocol];\n  if (!self.httpModule) return this.emit('error', new Error(\"Invalid protocol\"));\n  if (options.ca) self.ca = options.ca;\n\n  if (!self.agent) {\n    if (options.agentOptions) self.agentOptions = options.agentOptions;\n\n    if (options.agentClass) {\n      self.agentClass = options.agentClass;\n    } else if (options.forever) {\n      self.agentClass = protocol === 'http:' ? ForeverAgent : ForeverAgent.SSL;\n    } else {\n      self.agentClass = self.httpModule.Agent;\n    }\n  }\n\n  if (self.pool === false) {\n    self.agent = false;\n  } else {\n    self.agent = self.agent || self.getAgent();\n\n    if (self.maxSockets) {\n      // Don't use our pooling if node has the refactored client\n      self.agent.maxSockets = self.maxSockets;\n    }\n\n    if (self.pool.maxSockets) {\n      // Don't use our pooling if node has the refactored client\n      self.agent.maxSockets = self.pool.maxSockets;\n    }\n  }\n\n  self.once('pipe', function (src) {\n    if (self.ntick && self._started) throw new Error(\"You cannot pipe to this stream after the outbound request has started.\");\n    self.src = src;\n\n    if (isReadStream(src)) {\n      if (!self.headers['content-type'] && !self.headers['Content-Type']) self.headers['content-type'] = mime.lookup(src.path);\n    } else {\n      if (src.headers) {\n        for (var i in src.headers) {\n          if (!self.headers[i]) {\n            self.headers[i] = src.headers[i];\n          }\n        }\n      }\n\n      if (self._json && !self.headers['content-type'] && !self.headers['Content-Type']) self.headers['content-type'] = 'application/json';\n\n      if (src.method && !self.explicitMethod) {\n        self.method = src.method;\n      }\n    }\n\n    self.on('pipe', function () {\n      console.error(\"You have already piped to this stream. Pipeing twice is likely to break the request.\");\n    });\n  });\n  process.nextTick(function () {\n    if (self._aborted) return;\n\n    if (self._form) {\n      self.setHeaders(self._form.getHeaders());\n\n      self._form.pipe(self);\n    }\n\n    if (self.body) {\n      if (Array.isArray(self.body)) {\n        self.body.forEach(function (part) {\n          self.write(part);\n        });\n      } else {\n        self.write(self.body);\n      }\n\n      self.end();\n    } else if (self.requestBodyStream) {\n      console.warn(\"options.requestBodyStream is deprecated, please pass the request object to stream.pipe.\");\n      self.requestBodyStream.pipe(self);\n    } else if (!self.src) {\n      if (self.method !== 'GET' && typeof self.method !== 'undefined') {\n        self.headers['content-length'] = 0;\n      }\n\n      self.end();\n    }\n\n    self.ntick = true;\n  });\n}; // Must call this when following a redirect from https to http or vice versa\n// Attempts to keep everything as identical as possible, but update the\n// httpModule, Tunneling agent, and/or Forever Agent in use.\n\n\nRequest.prototype._updateProtocol = function () {\n  var self = this;\n  var protocol = self.uri.protocol;\n\n  if (protocol === 'https:') {\n    // previously was doing http, now doing https\n    // if it's https, then we might need to tunnel now.\n    if (self.proxy) {\n      self.tunnel = true;\n      var tunnelFn = self.proxy.protocol === 'http:' ? tunnel.httpsOverHttp : tunnel.httpsOverHttps;\n      var tunnelOptions = {\n        proxy: {\n          host: self.proxy.hostname,\n          port: +self.proxy.port,\n          proxyAuth: self.proxy.auth\n        },\n        rejectUnauthorized: self.rejectUnauthorized,\n        ca: self.ca\n      };\n      self.agent = tunnelFn(tunnelOptions);\n      return;\n    }\n\n    self.httpModule = https;\n\n    switch (self.agentClass) {\n      case ForeverAgent:\n        self.agentClass = ForeverAgent.SSL;\n        break;\n\n      case http.Agent:\n        self.agentClass = https.Agent;\n        break;\n\n      default:\n        // nothing we can do.  Just hope for the best.\n        return;\n    } // if there's an agent, we need to get a new one.\n\n\n    if (self.agent) self.agent = self.getAgent();\n  } else {\n    // previously was doing https, now doing http\n    // stop any tunneling.\n    if (self.tunnel) self.tunnel = false;\n    self.httpModule = http;\n\n    switch (self.agentClass) {\n      case ForeverAgent.SSL:\n        self.agentClass = ForeverAgent;\n        break;\n\n      case https.Agent:\n        self.agentClass = http.Agent;\n        break;\n\n      default:\n        // nothing we can do.  just hope for the best\n        return;\n    } // if there's an agent, then get a new one.\n\n\n    if (self.agent) {\n      self.agent = null;\n      self.agent = self.getAgent();\n    }\n  }\n};\n\nRequest.prototype.getAgent = function () {\n  var Agent = this.agentClass;\n  var options = {};\n\n  if (this.agentOptions) {\n    for (var i in this.agentOptions) {\n      options[i] = this.agentOptions[i];\n    }\n  }\n\n  if (this.ca) options.ca = this.ca;\n  if (typeof this.rejectUnauthorized !== 'undefined') options.rejectUnauthorized = this.rejectUnauthorized;\n\n  if (this.cert && this.key) {\n    options.key = this.key;\n    options.cert = this.cert;\n  }\n\n  var poolKey = ''; // different types of agents are in different pools\n\n  if (Agent !== this.httpModule.Agent) {\n    poolKey += Agent.name;\n  }\n\n  if (!this.httpModule.globalAgent) {\n    // node 0.4.x\n    options.host = this.host;\n    options.port = this.port;\n    if (poolKey) poolKey += ':';\n    poolKey += this.host + ':' + this.port;\n  } // ca option is only relevant if proxy or destination are https\n\n\n  var proxy = this.proxy;\n  if (typeof proxy === 'string') proxy = url.parse(proxy);\n  var isHttps = proxy && proxy.protocol === 'https:' || this.uri.protocol === 'https:';\n\n  if (isHttps) {\n    if (options.ca) {\n      if (poolKey) poolKey += ':';\n      poolKey += options.ca;\n    }\n\n    if (typeof options.rejectUnauthorized !== 'undefined') {\n      if (poolKey) poolKey += ':';\n      poolKey += options.rejectUnauthorized;\n    }\n\n    if (options.cert) poolKey += options.cert.toString('ascii') + options.key.toString('ascii');\n  }\n\n  if (!poolKey && Agent === this.httpModule.Agent && this.httpModule.globalAgent) {\n    // not doing anything special.  Use the globalAgent\n    return this.httpModule.globalAgent;\n  } // we're using a stored agent.  Make sure it's protocol-specific\n\n\n  poolKey = this.uri.protocol + poolKey; // already generated an agent for this setting\n\n  if (this.pool[poolKey]) return this.pool[poolKey];\n  return this.pool[poolKey] = new Agent(options);\n};\n\nRequest.prototype.start = function () {\n  // start() is called once we are ready to send the outgoing HTTP request.\n  // this is usually called on the first write(), end() or on nextTick()\n  var self = this;\n  if (self._aborted) return;\n  self._started = true;\n  self.method = self.method || 'GET';\n  self.href = self.uri.href;\n\n  if (self.src && self.src.stat && self.src.stat.size && !self.headers['content-length'] && !self.headers['Content-Length']) {\n    self.headers['content-length'] = self.src.stat.size;\n  }\n\n  if (self._aws) {\n    self.aws(self._aws, true);\n  } // We have a method named auth, which is completely different from the http.request\n  // auth option.  If we don't remove it, we're gonna have a bad time.\n\n\n  var reqOptions = copy(self);\n  delete reqOptions.auth;\n  debug('make request', self.uri.href);\n  self.req = self.httpModule.request(reqOptions, self.onResponse.bind(self));\n\n  if (self.timeout && !self.timeoutTimer) {\n    self.timeoutTimer = setTimeout(function () {\n      self.req.abort();\n      var e = new Error(\"ETIMEDOUT\");\n      e.code = \"ETIMEDOUT\";\n      self.emit(\"error\", e);\n    }, self.timeout); // Set additional timeout on socket - in case if remote\n    // server freeze after sending headers\n\n    if (self.req.setTimeout) {\n      // only works on node 0.6+\n      self.req.setTimeout(self.timeout, function () {\n        if (self.req) {\n          self.req.abort();\n          var e = new Error(\"ESOCKETTIMEDOUT\");\n          e.code = \"ESOCKETTIMEDOUT\";\n          self.emit(\"error\", e);\n        }\n      });\n    }\n  }\n\n  self.req.on('error', self.clientErrorHandler);\n  self.req.on('drain', function () {\n    self.emit('drain');\n  });\n  self.on('end', function () {\n    if (self.req.connection) self.req.connection.removeListener('error', self._parserErrorHandler);\n  });\n  self.emit('request', self.req);\n};\n\nRequest.prototype.onResponse = function (response) {\n  var self = this;\n  debug('onResponse', self.uri.href, response.statusCode, response.headers);\n  response.on('end', function () {\n    debug('response end', self.uri.href, response.statusCode, response.headers);\n  });\n\n  if (response.connection.listeners('error').indexOf(self._parserErrorHandler) === -1) {\n    response.connection.once('error', self._parserErrorHandler);\n  }\n\n  if (self._aborted) {\n    debug('aborted', self.uri.href);\n    response.resume();\n    return;\n  }\n\n  if (self._paused) response.pause();else response.resume();\n  self.response = response;\n  response.request = self;\n  response.toJSON = toJSON; // XXX This is different on 0.10, because SSL is strict by default\n\n  if (self.httpModule === https && self.strictSSL && !response.client.authorized) {\n    debug('strict ssl error', self.uri.href);\n    var sslErr = response.client.authorizationError;\n    self.emit('error', new Error('SSL Error: ' + sslErr));\n    return;\n  }\n\n  if (self.setHost) delete self.headers.host;\n\n  if (self.timeout && self.timeoutTimer) {\n    clearTimeout(self.timeoutTimer);\n    self.timeoutTimer = null;\n  }\n\n  var addCookie = function (cookie) {\n    if (self._jar) self._jar.add(new Cookie(cookie));else cookieJar.add(new Cookie(cookie));\n  };\n\n  if (response.headers['set-cookie'] && !self._disableCookies) {\n    if (Array.isArray(response.headers['set-cookie'])) response.headers['set-cookie'].forEach(addCookie);else addCookie(response.headers['set-cookie']);\n  }\n\n  var redirectTo = null;\n\n  if (response.statusCode >= 300 && response.statusCode < 400 && response.headers.location) {\n    debug('redirect', response.headers.location);\n\n    if (self.followAllRedirects) {\n      redirectTo = response.headers.location;\n    } else if (self.followRedirect) {\n      switch (self.method) {\n        case 'PATCH':\n        case 'PUT':\n        case 'POST':\n        case 'DELETE':\n          // Do not follow redirects\n          break;\n\n        default:\n          redirectTo = response.headers.location;\n          break;\n      }\n    }\n  } else if (response.statusCode == 401 && self._hasAuth && !self._sentAuth) {\n    var authHeader = response.headers['www-authenticate'];\n    var authVerb = authHeader && authHeader.split(' ')[0];\n    debug('reauth', authVerb);\n\n    switch (authVerb) {\n      case 'Basic':\n        self.auth(self._user, self._pass, true);\n        redirectTo = self.uri;\n        break;\n\n      case 'Digest':\n        // TODO: More complete implementation of RFC 2617.  For reference:\n        // http://tools.ietf.org/html/rfc2617#section-3\n        // https://github.com/bagder/curl/blob/master/lib/http_digest.c\n        var matches = authHeader.match(/([a-z0-9_-]+)=\"([^\"]+)\"/gi);\n        var challenge = {};\n\n        for (var i = 0; i < matches.length; i++) {\n          var eqPos = matches[i].indexOf('=');\n          var key = matches[i].substring(0, eqPos);\n          var quotedValue = matches[i].substring(eqPos + 1);\n          challenge[key] = quotedValue.substring(1, quotedValue.length - 1);\n        }\n\n        var ha1 = md5(self._user + ':' + challenge.realm + ':' + self._pass);\n        var ha2 = md5(self.method + ':' + self.uri.path);\n        var digestResponse = md5(ha1 + ':' + challenge.nonce + ':1::auth:' + ha2);\n        var authValues = {\n          username: self._user,\n          realm: challenge.realm,\n          nonce: challenge.nonce,\n          uri: self.uri.path,\n          qop: challenge.qop,\n          response: digestResponse,\n          nc: 1,\n          cnonce: ''\n        };\n        authHeader = [];\n\n        for (var k in authValues) {\n          authHeader.push(k + '=\"' + authValues[k] + '\"');\n        }\n\n        authHeader = 'Digest ' + authHeader.join(', ');\n        self.setHeader('authorization', authHeader);\n        self._sentAuth = true;\n        redirectTo = self.uri;\n        break;\n    }\n  }\n\n  if (redirectTo) {\n    debug('redirect to', redirectTo); // ignore any potential response body.  it cannot possibly be useful\n    // to us at this point.\n\n    if (self._paused) response.resume();\n\n    if (self._redirectsFollowed >= self.maxRedirects) {\n      self.emit('error', new Error(\"Exceeded maxRedirects. Probably stuck in a redirect loop \" + self.uri.href));\n      return;\n    }\n\n    self._redirectsFollowed += 1;\n\n    if (!isUrl.test(redirectTo)) {\n      redirectTo = url.resolve(self.uri.href, redirectTo);\n    }\n\n    var uriPrev = self.uri;\n    self.uri = url.parse(redirectTo); // handle the case where we change protocol from https to http or vice versa\n\n    if (self.uri.protocol !== uriPrev.protocol) {\n      self._updateProtocol();\n    }\n\n    self.redirects.push({\n      statusCode: response.statusCode,\n      redirectUri: redirectTo\n    });\n    if (self.followAllRedirects && response.statusCode != 401) self.method = 'GET'; // self.method = 'GET' // Force all redirects to use GET || commented out fixes #215\n\n    delete self.src;\n    delete self.req;\n    delete self.agent;\n    delete self._started;\n\n    if (response.statusCode != 401) {\n      // Remove parameters from the previous response, unless this is the second request\n      // for a server that requires digest authentication.\n      delete self.body;\n      delete self._form;\n\n      if (self.headers) {\n        delete self.headers.host;\n        delete self.headers['content-type'];\n        delete self.headers['content-length'];\n      }\n    }\n\n    self.emit('redirect');\n    self.init();\n    return; // Ignore the rest of the response\n  } else {\n    self._redirectsFollowed = self._redirectsFollowed || 0; // Be a good stream and emit end when the response is finished.\n    // Hack to emit end on close because of a core bug that never fires end\n\n    response.on('close', function () {\n      if (!self._ended) self.response.emit('end');\n    });\n\n    if (self.encoding) {\n      if (self.dests.length !== 0) {\n        console.error(\"Ingoring encoding parameter as this stream is being piped to another stream which makes the encoding option invalid.\");\n      } else {\n        response.setEncoding(self.encoding);\n      }\n    }\n\n    self.emit('response', response);\n    self.dests.forEach(function (dest) {\n      self.pipeDest(dest);\n    });\n    response.on(\"data\", function (chunk) {\n      self._destdata = true;\n      self.emit(\"data\", chunk);\n    });\n    response.on(\"end\", function (chunk) {\n      self._ended = true;\n      self.emit(\"end\", chunk);\n    });\n    response.on(\"close\", function () {\n      self.emit(\"close\");\n    });\n\n    if (self.callback) {\n      var buffer = [];\n      var bodyLen = 0;\n      self.on(\"data\", function (chunk) {\n        buffer.push(chunk);\n        bodyLen += chunk.length;\n      });\n      self.on(\"end\", function () {\n        debug('end event', self.uri.href);\n\n        if (self._aborted) {\n          debug('aborted', self.uri.href);\n          return;\n        }\n\n        if (buffer.length && Buffer.isBuffer(buffer[0])) {\n          debug('has body', self.uri.href, bodyLen);\n          var body = new Buffer(bodyLen);\n          var i = 0;\n          buffer.forEach(function (chunk) {\n            chunk.copy(body, i, 0, chunk.length);\n            i += chunk.length;\n          });\n\n          if (self.encoding === null) {\n            response.body = body;\n          } else {\n            response.body = body.toString(self.encoding);\n          }\n        } else if (buffer.length) {\n          // The UTF8 BOM [0xEF,0xBB,0xBF] is converted to [0xFE,0xFF] in the JS UTC16/UCS2 representation.\n          // Strip this value out when the encoding is set to 'utf8', as upstream consumers won't expect it and it breaks JSON.parse().\n          if (self.encoding === 'utf8' && buffer[0].length > 0 && buffer[0][0] === \"\\uFEFF\") {\n            buffer[0] = buffer[0].substring(1);\n          }\n\n          response.body = buffer.join('');\n        }\n\n        if (self._json) {\n          try {\n            response.body = JSON.parse(response.body);\n          } catch (e) {}\n        }\n\n        debug('emitting complete', self.uri.href);\n\n        if (response.body == undefined && !self._json) {\n          response.body = \"\";\n        }\n\n        self.emit('complete', response, response.body);\n      });\n    }\n  }\n\n  debug('finish init function', self.uri.href);\n};\n\nRequest.prototype.abort = function () {\n  this._aborted = true;\n\n  if (this.req) {\n    this.req.abort();\n  } else if (this.response) {\n    this.response.abort();\n  }\n\n  this.emit(\"abort\");\n};\n\nRequest.prototype.pipeDest = function (dest) {\n  var response = this.response; // Called after the response is received\n\n  if (dest.headers) {\n    dest.headers['content-type'] = response.headers['content-type'];\n\n    if (response.headers['content-length']) {\n      dest.headers['content-length'] = response.headers['content-length'];\n    }\n  }\n\n  if (dest.setHeader) {\n    for (var i in response.headers) {\n      dest.setHeader(i, response.headers[i]);\n    }\n\n    dest.statusCode = response.statusCode;\n  }\n\n  if (this.pipefilter) this.pipefilter(response, dest);\n}; // Composable API\n\n\nRequest.prototype.setHeader = function (name, value, clobber) {\n  if (clobber === undefined) clobber = true;\n  if (clobber || !this.headers.hasOwnProperty(name)) this.headers[name] = value;else this.headers[name] += ',' + value;\n  return this;\n};\n\nRequest.prototype.setHeaders = function (headers) {\n  for (var i in headers) {\n    this.setHeader(i, headers[i]);\n  }\n\n  return this;\n};\n\nRequest.prototype.qs = function (q, clobber) {\n  var base;\n  if (!clobber && this.uri.query) base = qs.parse(this.uri.query);else base = {};\n\n  for (var i in q) {\n    base[i] = q[i];\n  }\n\n  if (qs.stringify(base) === '') {\n    return this;\n  }\n\n  this.uri = url.parse(this.uri.href.split('?')[0] + '?' + qs.stringify(base));\n  this.url = this.uri;\n  this.path = this.uri.path;\n  return this;\n};\n\nRequest.prototype.form = function (form) {\n  if (form) {\n    this.headers['content-type'] = 'application/x-www-form-urlencoded; charset=utf-8';\n    this.body = qs.stringify(form).toString('utf8');\n    return this;\n  } // create form-data object\n\n\n  this._form = new FormData();\n  return this._form;\n};\n\nRequest.prototype.multipart = function (multipart) {\n  var self = this;\n  self.body = [];\n\n  if (!self.headers['content-type']) {\n    self.headers['content-type'] = 'multipart/related; boundary=' + self.boundary;\n  } else {\n    self.headers['content-type'] = self.headers['content-type'].split(';')[0] + '; boundary=' + self.boundary;\n  }\n\n  if (!multipart.forEach) throw new Error('Argument error, options.multipart.');\n\n  if (self.preambleCRLF) {\n    self.body.push(new Buffer('\\r\\n'));\n  }\n\n  multipart.forEach(function (part) {\n    var body = part.body;\n    if (body == null) throw Error('Body attribute missing in multipart.');\n    delete part.body;\n    var preamble = '--' + self.boundary + '\\r\\n';\n    Object.keys(part).forEach(function (key) {\n      preamble += key + ': ' + part[key] + '\\r\\n';\n    });\n    preamble += '\\r\\n';\n    self.body.push(new Buffer(preamble));\n    self.body.push(new Buffer(body));\n    self.body.push(new Buffer('\\r\\n'));\n  });\n  self.body.push(new Buffer('--' + self.boundary + '--'));\n  return self;\n};\n\nRequest.prototype.json = function (val) {\n  var self = this;\n\n  var setAcceptHeader = function () {\n    if (!self.headers['accept'] && !self.headers['Accept']) {\n      self.setHeader('accept', 'application/json');\n    }\n  };\n\n  setAcceptHeader();\n  this._json = true;\n\n  if (typeof val === 'boolean') {\n    if (typeof this.body === 'object') {\n      setAcceptHeader();\n      this.body = safeStringify(this.body);\n      self.setHeader('content-type', 'application/json');\n    }\n  } else {\n    setAcceptHeader();\n    this.body = safeStringify(val);\n    self.setHeader('content-type', 'application/json');\n  }\n\n  return this;\n};\n\nfunction getHeader(name, headers) {\n  var result, re, match;\n  Object.keys(headers).forEach(function (key) {\n    re = new RegExp(name, 'i');\n    match = key.match(re);\n    if (match) result = headers[key];\n  });\n  return result;\n}\n\nRequest.prototype.auth = function (user, pass, sendImmediately) {\n  if (typeof user !== 'string' || pass !== undefined && typeof pass !== 'string') {\n    throw new Error('auth() received invalid user or password');\n  }\n\n  this._user = user;\n  this._pass = pass;\n  this._hasAuth = true;\n\n  if (sendImmediately || typeof sendImmediately == 'undefined') {\n    this.setHeader('authorization', 'Basic ' + toBase64(user + ':' + pass));\n    this._sentAuth = true;\n  }\n\n  return this;\n};\n\nRequest.prototype.aws = function (opts, now) {\n  if (!now) {\n    this._aws = opts;\n    return this;\n  }\n\n  var date = new Date();\n  this.setHeader('date', date.toUTCString());\n  var auth = {\n    key: opts.key,\n    secret: opts.secret,\n    verb: this.method.toUpperCase(),\n    date: date,\n    contentType: getHeader('content-type', this.headers) || '',\n    md5: getHeader('content-md5', this.headers) || '',\n    amazonHeaders: aws.canonicalizeHeaders(this.headers)\n  };\n\n  if (opts.bucket && this.path) {\n    auth.resource = '/' + opts.bucket + this.path;\n  } else if (opts.bucket && !this.path) {\n    auth.resource = '/' + opts.bucket;\n  } else if (!opts.bucket && this.path) {\n    auth.resource = this.path;\n  } else if (!opts.bucket && !this.path) {\n    auth.resource = '/';\n  }\n\n  auth.resource = aws.canonicalizeResource(auth.resource);\n  this.setHeader('authorization', aws.authorization(auth));\n  return this;\n};\n\nRequest.prototype.httpSignature = function (opts) {\n  var req = this;\n  httpSignature.signRequest({\n    getHeader: function (header) {\n      return getHeader(header, req.headers);\n    },\n    setHeader: function (header, value) {\n      req.setHeader(header, value);\n    },\n    method: this.method,\n    path: this.path\n  }, opts);\n  debug('httpSignature authorization', getHeader('authorization', this.headers));\n  return this;\n};\n\nRequest.prototype.hawk = function (opts) {\n  this.headers.Authorization = hawk.client.header(this.uri, this.method, opts).field;\n};\n\nRequest.prototype.oauth = function (_oauth) {\n  var form;\n\n  if (this.headers['content-type'] && this.headers['content-type'].slice(0, 'application/x-www-form-urlencoded'.length) === 'application/x-www-form-urlencoded') {\n    form = qs.parse(this.body);\n  }\n\n  if (this.uri.query) {\n    form = qs.parse(this.uri.query);\n  }\n\n  if (!form) form = {};\n  var oa = {};\n\n  for (var i in form) oa[i] = form[i];\n\n  for (var i in _oauth) oa['oauth_' + i] = _oauth[i];\n\n  if (!oa.oauth_version) oa.oauth_version = '1.0';\n  if (!oa.oauth_timestamp) oa.oauth_timestamp = Math.floor(Date.now() / 1000).toString();\n  if (!oa.oauth_nonce) oa.oauth_nonce = uuid().replace(/-/g, '');\n  oa.oauth_signature_method = 'HMAC-SHA1';\n  var consumer_secret = oa.oauth_consumer_secret;\n  delete oa.oauth_consumer_secret;\n  var token_secret = oa.oauth_token_secret;\n  delete oa.oauth_token_secret;\n  var timestamp = oa.oauth_timestamp;\n  var baseurl = this.uri.protocol + '//' + this.uri.host + this.uri.pathname;\n  var signature = oauth.hmacsign(this.method, baseurl, oa, consumer_secret, token_secret); // oa.oauth_signature = signature\n\n  for (var i in form) {\n    if (i.slice(0, 'oauth_') in _oauth) {// skip\n    } else {\n      delete oa['oauth_' + i];\n      if (i !== 'x_auth_mode') delete oa[i];\n    }\n  }\n\n  oa.oauth_timestamp = timestamp;\n  this.headers.Authorization = 'OAuth ' + Object.keys(oa).sort().map(function (i) {\n    return i + '=\"' + oauth.rfc3986(oa[i]) + '\"';\n  }).join(',');\n  this.headers.Authorization += ',oauth_signature=\"' + oauth.rfc3986(signature) + '\"';\n  return this;\n};\n\nRequest.prototype.jar = function (jar) {\n  var cookies;\n\n  if (this._redirectsFollowed === 0) {\n    this.originalCookieHeader = this.headers.cookie;\n  }\n\n  if (jar === false) {\n    // disable cookies\n    cookies = false;\n    this._disableCookies = true;\n  } else if (jar) {\n    // fetch cookie from the user defined cookie jar\n    cookies = jar.get({\n      url: this.uri.href\n    });\n  } else {\n    // fetch cookie from the global cookie jar\n    cookies = cookieJar.get({\n      url: this.uri.href\n    });\n  }\n\n  if (cookies && cookies.length) {\n    var cookieString = cookies.map(function (c) {\n      return c.name + \"=\" + c.value;\n    }).join(\"; \");\n\n    if (this.originalCookieHeader) {\n      // Don't overwrite existing Cookie header\n      this.headers.cookie = this.originalCookieHeader + '; ' + cookieString;\n    } else {\n      this.headers.cookie = cookieString;\n    }\n  }\n\n  this._jar = jar;\n  return this;\n}; // Stream API\n\n\nRequest.prototype.pipe = function (dest, opts) {\n  if (this.response) {\n    if (this._destdata) {\n      throw new Error(\"You cannot pipe after data has been emitted from the response.\");\n    } else if (this._ended) {\n      throw new Error(\"You cannot pipe after the response has been ended.\");\n    } else {\n      stream.Stream.prototype.pipe.call(this, dest, opts);\n      this.pipeDest(dest);\n      return dest;\n    }\n  } else {\n    this.dests.push(dest);\n    stream.Stream.prototype.pipe.call(this, dest, opts);\n    return dest;\n  }\n};\n\nRequest.prototype.write = function () {\n  if (!this._started) this.start();\n  return this.req.write.apply(this.req, arguments);\n};\n\nRequest.prototype.end = function (chunk) {\n  if (chunk) this.write(chunk);\n  if (!this._started) this.start();\n  this.req.end();\n};\n\nRequest.prototype.pause = function () {\n  if (!this.response) this._paused = true;else this.response.pause.apply(this.response, arguments);\n};\n\nRequest.prototype.resume = function () {\n  if (!this.response) this._paused = false;else this.response.resume.apply(this.response, arguments);\n};\n\nRequest.prototype.destroy = function () {\n  if (!this._ended) this.end();else if (this.response) this.response.destroy();\n}; // organize params for patch, post, put, head, del\n\n\nfunction initParams(uri, options, callback) {\n  if (typeof options === 'function' && !callback) callback = options;\n\n  if (options && typeof options === 'object') {\n    options.uri = uri;\n  } else if (typeof uri === 'string') {\n    options = {\n      uri: uri\n    };\n  } else {\n    options = uri;\n    uri = options.uri;\n  }\n\n  return {\n    uri: uri,\n    options: options,\n    callback: callback\n  };\n}\n\nfunction request(uri, options, callback) {\n  if (typeof uri === 'undefined') throw new Error('undefined is not a valid uri or options object.');\n  if (typeof options === 'function' && !callback) callback = options;\n\n  if (options && typeof options === 'object') {\n    options.uri = uri;\n  } else if (typeof uri === 'string') {\n    options = {\n      uri: uri\n    };\n  } else {\n    options = uri;\n  }\n\n  options = copy(options);\n  if (callback) options.callback = callback;\n  var r = new Request(options);\n  return r;\n}\n\nmodule.exports = request;\nrequest.debug = process.env.NODE_DEBUG && /request/.test(process.env.NODE_DEBUG);\nrequest.initParams = initParams;\n\nrequest.defaults = function (options, requester) {\n  var def = function (method) {\n    var d = function (uri, opts, callback) {\n      var params = initParams(uri, opts, callback);\n\n      for (var i in options) {\n        if (params.options[i] === undefined) params.options[i] = options[i];\n      }\n\n      if (typeof requester === 'function') {\n        if (method === request) {\n          method = requester;\n        } else {\n          params.options._requester = requester;\n        }\n      }\n\n      return method(params.options, params.callback);\n    };\n\n    return d;\n  };\n\n  var de = def(request);\n  de.get = def(request.get);\n  de.patch = def(request.patch);\n  de.post = def(request.post);\n  de.put = def(request.put);\n  de.head = def(request.head);\n  de.del = def(request.del);\n  de.cookie = def(request.cookie);\n  de.jar = request.jar;\n  return de;\n};\n\nrequest.forever = function (agentOptions, optionsArg) {\n  var options = {};\n\n  if (optionsArg) {\n    for (option in optionsArg) {\n      options[option] = optionsArg[option];\n    }\n  }\n\n  if (agentOptions) options.agentOptions = agentOptions;\n  options.forever = true;\n  return request.defaults(options);\n};\n\nrequest.get = request;\n\nrequest.post = function (uri, options, callback) {\n  var params = initParams(uri, options, callback);\n  params.options.method = 'POST';\n  return request(params.uri || null, params.options, params.callback);\n};\n\nrequest.put = function (uri, options, callback) {\n  var params = initParams(uri, options, callback);\n  params.options.method = 'PUT';\n  return request(params.uri || null, params.options, params.callback);\n};\n\nrequest.patch = function (uri, options, callback) {\n  var params = initParams(uri, options, callback);\n  params.options.method = 'PATCH';\n  return request(params.uri || null, params.options, params.callback);\n};\n\nrequest.head = function (uri, options, callback) {\n  var params = initParams(uri, options, callback);\n  params.options.method = 'HEAD';\n\n  if (params.options.body || params.options.requestBodyStream || params.options.json && typeof params.options.json !== 'boolean' || params.options.multipart) {\n    throw new Error(\"HTTP HEAD requests MUST NOT include a request body.\");\n  }\n\n  return request(params.uri || null, params.options, params.callback);\n};\n\nrequest.del = function (uri, options, callback) {\n  var params = initParams(uri, options, callback);\n  params.options.method = 'DELETE';\n\n  if (typeof params.options._requester === 'function') {\n    request = params.options._requester;\n  }\n\n  return request(params.uri || null, params.options, params.callback);\n};\n\nrequest.jar = function () {\n  return new CookieJar();\n};\n\nrequest.cookie = function (str) {\n  if (str && str.uri) str = str.uri;\n  if (typeof str !== 'string') throw new Error(\"The cookie function only accepts STRING as param\");\n  return new Cookie(str);\n}; // Safe toJSON\n\n\nfunction getSafe(self, uuid) {\n  if (typeof self === 'object' || typeof self === 'function') var safe = {};\n  if (Array.isArray(self)) var safe = [];\n  var recurse = [];\n  Object.defineProperty(self, uuid, {});\n  var attrs = Object.keys(self).filter(function (i) {\n    if (i === uuid) return false;\n    if (typeof self[i] !== 'object' && typeof self[i] !== 'function' || self[i] === null) return true;\n    return !Object.getOwnPropertyDescriptor(self[i], uuid);\n  });\n\n  for (var i = 0; i < attrs.length; i++) {\n    if (typeof self[attrs[i]] !== 'object' && typeof self[attrs[i]] !== 'function' || self[attrs[i]] === null) {\n      safe[attrs[i]] = self[attrs[i]];\n    } else {\n      recurse.push(attrs[i]);\n      Object.defineProperty(self[attrs[i]], uuid, {});\n    }\n  }\n\n  for (var i = 0; i < recurse.length; i++) {\n    safe[recurse[i]] = getSafe(self[recurse[i]], uuid);\n  }\n\n  return safe;\n}\n\nfunction toJSON() {\n  return getSafe(this, '__' + ((1 + Math.random()) * 0x10000 | 0).toString(16));\n}\n\nRequest.prototype.toJSON = toJSON;","map":{"version":3,"sources":["/home/hayaz/haya/haya/hosters.pk/node_modules/whmcs/node_modules/request/index.js"],"names":["http","require","https","tls","url","util","stream","qs","querystring","crypto","oauth","hawk","aws","httpSignature","uuid","mime","tunnel","safeStringify","ForeverAgent","FormData","Cookie","CookieJar","Jar","cookieJar","e","debug","test","process","env","NODE_DEBUG","console","error","format","apply","arguments","toBase64","str","Buffer","toString","md5","createHash","update","digest","Agent","options","call","inherits","prototype","_getConnection","host","port","cb","s","connect","isReadStream","rs","readable","path","mode","copy","obj","o","Object","keys","forEach","i","isUrl","globalPool","Request","Stream","writable","uri","reserved","indexOf","method","explicitMethod","init","self","localAddress","pool","dests","__isRequestRequest","_callback","callback","_callbackCalled","on","bind","emit","Error","parse","strictSSL","rejectUnauthorized","proxy","globalAgent","protocol","tunnelFn","httpsOverHttp","httpsOverHttps","tunnelOptions","hostname","proxyAuth","auth","headers","Host","ca","agent","pathname","faultyUri","message","length","_redirectsFollowed","maxRedirects","undefined","followRedirect","followAllRedirects","redirects","setHost","jar","_jar","clientErrorHandler","_aborted","req","_reusedSocket","code","addRequestNoreuse","addRequest","start","end","timeout","timeoutTimer","clearTimeout","_parserErrorHandler","res","request","_httpMessage","form","search","user","username","pass","password","sendImmediately","authorization","authPieces","split","map","item","unescape","slice","join","json","multipart","boundary","body","isBuffer","Array","isArray","defaultModules","httpModules","httpModule","agentOptions","agentClass","forever","SSL","getAgent","maxSockets","once","src","ntick","_started","lookup","_json","nextTick","_form","setHeaders","getHeaders","pipe","part","write","requestBodyStream","warn","_updateProtocol","cert","key","poolKey","name","isHttps","href","stat","size","_aws","reqOptions","onResponse","setTimeout","abort","connection","removeListener","response","statusCode","listeners","resume","_paused","pause","toJSON","client","authorized","sslErr","authorizationError","addCookie","cookie","add","_disableCookies","redirectTo","location","_hasAuth","_sentAuth","authHeader","authVerb","_user","_pass","matches","match","challenge","eqPos","substring","quotedValue","ha1","realm","ha2","digestResponse","nonce","authValues","qop","nc","cnonce","k","push","setHeader","resolve","uriPrev","redirectUri","_ended","encoding","setEncoding","dest","pipeDest","chunk","_destdata","buffer","bodyLen","JSON","pipefilter","value","clobber","hasOwnProperty","q","base","query","stringify","preambleCRLF","preamble","val","setAcceptHeader","getHeader","result","re","RegExp","opts","now","date","Date","toUTCString","secret","verb","toUpperCase","contentType","amazonHeaders","canonicalizeHeaders","bucket","resource","canonicalizeResource","signRequest","header","Authorization","field","_oauth","oa","oauth_version","oauth_timestamp","Math","floor","oauth_nonce","replace","oauth_signature_method","consumer_secret","oauth_consumer_secret","token_secret","oauth_token_secret","timestamp","baseurl","signature","hmacsign","sort","rfc3986","cookies","originalCookieHeader","get","cookieString","c","destroy","initParams","r","module","exports","defaults","requester","def","d","params","_requester","de","patch","post","put","head","del","optionsArg","option","getSafe","safe","recurse","defineProperty","attrs","filter","getOwnPropertyDescriptor","random"],"mappings":"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","sourcesContent":["// Copyright 2010-2012 Mikeal Rogers\n//\n//    Licensed under the Apache License, Version 2.0 (the \"License\");\n//    you may not use this file except in compliance with the License.\n//    You may obtain a copy of the License at\n//\n//        http://www.apache.org/licenses/LICENSE-2.0\n//\n//    Unless required by applicable law or agreed to in writing, software\n//    distributed under the License is distributed on an \"AS IS\" BASIS,\n//    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n//    See the License for the specific language governing permissions and\n//    limitations under the License.\n\nvar http = require('http')\n  , https = false\n  , tls = false\n  , url = require('url')\n  , util = require('util')\n  , stream = require('stream')\n  , qs = require('qs')\n  , querystring = require('querystring')\n  , crypto = require('crypto')\n\n  , oauth = require('oauth-sign')\n  , hawk = require('hawk')\n  , aws = require('aws-sign')\n  , httpSignature = require('http-signature')\n  , uuid = require('node-uuid')\n  , mime = require('mime')\n  , tunnel = require('tunnel-agent')\n  , safeStringify = require('json-stringify-safe')\n\n  , ForeverAgent = require('forever-agent')\n  , FormData = require('form-data')\n\n  , Cookie = require('cookie-jar')\n  , CookieJar = Cookie.Jar\n  , cookieJar = new CookieJar\n  ;\n\ntry {\n  https = require('https')\n} catch (e) {}\n\ntry {\n  tls = require('tls')\n} catch (e) {}\n\nvar debug\nif (/\\brequest\\b/.test(process.env.NODE_DEBUG)) {\n  debug = function() {\n    console.error('REQUEST %s', util.format.apply(util, arguments))\n  }\n} else {\n  debug = function() {}\n}\n\nfunction toBase64 (str) {\n  return (new Buffer(str || \"\", \"ascii\")).toString(\"base64\")\n}\n\nfunction md5 (str) {\n  return crypto.createHash('md5').update(str).digest('hex')\n}\n\n// Hacky fix for pre-0.4.4 https\nif (https && !https.Agent) {\n  https.Agent = function (options) {\n    http.Agent.call(this, options)\n  }\n  util.inherits(https.Agent, http.Agent)\n  https.Agent.prototype._getConnection = function (host, port, cb) {\n    var s = tls.connect(port, host, this.options, function () {\n      // do other checks here?\n      if (cb) cb()\n    })\n    return s\n  }\n}\n\nfunction isReadStream (rs) {\n  if (rs.readable && rs.path && rs.mode) {\n    return true\n  }\n}\n\nfunction copy (obj) {\n  var o = {}\n  Object.keys(obj).forEach(function (i) {\n    o[i] = obj[i]\n  })\n  return o\n}\n\nvar isUrl = /^https?:/\n\nvar globalPool = {}\n\nfunction Request (options) {\n  stream.Stream.call(this)\n  this.readable = true\n  this.writable = true\n\n  if (typeof options === 'string') {\n    options = {uri:options}\n  }\n\n  var reserved = Object.keys(Request.prototype)\n  for (var i in options) {\n    if (reserved.indexOf(i) === -1) {\n      this[i] = options[i]\n    } else {\n      if (typeof options[i] === 'function') {\n        delete options[i]\n      }\n    }\n  }\n\n  if (options.method) {\n    this.explicitMethod = true\n  }\n\n  this.init(options)\n}\nutil.inherits(Request, stream.Stream)\nRequest.prototype.init = function (options) {\n  // init() contains all the code to setup the request object.\n  // the actual outgoing request is not started until start() is called\n  // this function is called from both the constructor and on redirect.\n  var self = this\n  if (!options) options = {}\n\n  if (!self.method) self.method = options.method || 'GET'\n  self.localAddress = options.localAddress\n\n  debug(options)\n  if (!self.pool && self.pool !== false) self.pool = globalPool\n  self.dests = self.dests || []\n  self.__isRequestRequest = true\n\n  // Protect against double callback\n  if (!self._callback && self.callback) {\n    self._callback = self.callback\n    self.callback = function () {\n      if (self._callbackCalled) return // Print a warning maybe?\n      self._callbackCalled = true\n      self._callback.apply(self, arguments)\n    }\n    self.on('error', self.callback.bind())\n    self.on('complete', self.callback.bind(self, null))\n  }\n\n  if (self.url) {\n    // People use this property instead all the time so why not just support it.\n    self.uri = self.url\n    delete self.url\n  }\n\n  if (!self.uri) {\n    // this will throw if unhandled but is handleable when in a redirect\n    return self.emit('error', new Error(\"options.uri is a required argument\"))\n  } else {\n    if (typeof self.uri == \"string\") self.uri = url.parse(self.uri)\n  }\n\n  if (self.strictSSL === false) {\n    self.rejectUnauthorized = false\n  }\n\n  if (self.proxy) {\n    if (typeof self.proxy == 'string') self.proxy = url.parse(self.proxy)\n\n    // do the HTTP CONNECT dance using koichik/node-tunnel\n    if (http.globalAgent && self.uri.protocol === \"https:\") {\n      var tunnelFn = self.proxy.protocol === \"http:\"\n                   ? tunnel.httpsOverHttp : tunnel.httpsOverHttps\n\n      var tunnelOptions = { proxy: { host: self.proxy.hostname\n                                   , port: +self.proxy.port\n                                   , proxyAuth: self.proxy.auth\n                                   , headers: { Host: self.uri.hostname + ':' +\n                                        (self.uri.port || self.uri.protocol === 'https:' ? 443 : 80) }}\n                          , rejectUnauthorized: self.rejectUnauthorized\n                          , ca: this.ca }\n\n      self.agent = tunnelFn(tunnelOptions)\n      self.tunnel = true\n    }\n  }\n\n  if (!self.uri.host || !self.uri.pathname) {\n    // Invalid URI: it may generate lot of bad errors, like \"TypeError: Cannot call method 'indexOf' of undefined\" in CookieJar\n    // Detect and reject it as soon as possible\n    var faultyUri = url.format(self.uri)\n    var message = 'Invalid URI \"' + faultyUri + '\"'\n    if (Object.keys(options).length === 0) {\n      // No option ? This can be the sign of a redirect\n      // As this is a case where the user cannot do anything (he didn't call request directly with this URL)\n      // he should be warned that it can be caused by a redirection (can save some hair)\n      message += '. This can be caused by a crappy redirection.'\n    }\n    self.emit('error', new Error(message))\n    return // This error was fatal\n  }\n\n  self._redirectsFollowed = self._redirectsFollowed || 0\n  self.maxRedirects = (self.maxRedirects !== undefined) ? self.maxRedirects : 10\n  self.followRedirect = (self.followRedirect !== undefined) ? self.followRedirect : true\n  self.followAllRedirects = (self.followAllRedirects !== undefined) ? self.followAllRedirects : false\n  if (self.followRedirect || self.followAllRedirects)\n    self.redirects = self.redirects || []\n\n  self.headers = self.headers ? copy(self.headers) : {}\n\n  self.setHost = false\n  if (!(self.headers.host || self.headers.Host)) {\n    self.headers.host = self.uri.hostname\n    if (self.uri.port) {\n      if ( !(self.uri.port === 80 && self.uri.protocol === 'http:') &&\n           !(self.uri.port === 443 && self.uri.protocol === 'https:') )\n      self.headers.host += (':'+self.uri.port)\n    }\n    self.setHost = true\n  }\n\n  self.jar(self._jar || options.jar)\n\n  if (!self.uri.pathname) {self.uri.pathname = '/'}\n  if (!self.uri.port) {\n    if (self.uri.protocol == 'http:') {self.uri.port = 80}\n    else if (self.uri.protocol == 'https:') {self.uri.port = 443}\n  }\n\n  if (self.proxy && !self.tunnel) {\n    self.port = self.proxy.port\n    self.host = self.proxy.hostname\n  } else {\n    self.port = self.uri.port\n    self.host = self.uri.hostname\n  }\n\n  self.clientErrorHandler = function (error) {\n    if (self._aborted) return\n\n    if (self.req && self.req._reusedSocket && error.code === 'ECONNRESET'\n        && self.agent.addRequestNoreuse) {\n      self.agent = { addRequest: self.agent.addRequestNoreuse.bind(self.agent) }\n      self.start()\n      self.req.end()\n      return\n    }\n    if (self.timeout && self.timeoutTimer) {\n      clearTimeout(self.timeoutTimer)\n      self.timeoutTimer = null\n    }\n    self.emit('error', error)\n  }\n\n  self._parserErrorHandler = function (error) {\n    if (this.res) {\n      if (this.res.request) {\n        this.res.request.emit('error', error)\n      } else {\n        this.res.emit('error', error)\n      }\n    } else {\n      this._httpMessage.emit('error', error)\n    }\n  }\n\n  if (options.form) {\n    self.form(options.form)\n  }\n\n  if (options.qs) self.qs(options.qs)\n\n  if (self.uri.path) {\n    self.path = self.uri.path\n  } else {\n    self.path = self.uri.pathname + (self.uri.search || \"\")\n  }\n\n  if (self.path.length === 0) self.path = '/'\n\n\n  // Auth must happen last in case signing is dependent on other headers\n  if (options.oauth) {\n    self.oauth(options.oauth)\n  }\n\n  if (options.aws) {\n    self.aws(options.aws)\n  }\n\n  if (options.hawk) {\n    self.hawk(options.hawk)\n  }\n\n  if (options.httpSignature) {\n    self.httpSignature(options.httpSignature)\n  }\n\n  if (options.auth) {\n    self.auth(\n      (options.auth.user===\"\") ? options.auth.user : (options.auth.user || options.auth.username ),\n      options.auth.pass || options.auth.password,\n      options.auth.sendImmediately)\n  }\n\n  if (self.uri.auth && !self.headers.authorization) {\n    var authPieces = self.uri.auth.split(':').map(function(item){ return querystring.unescape(item) })\n    self.auth(authPieces[0], authPieces.slice(1).join(':'), true)\n  }\n  if (self.proxy && self.proxy.auth && !self.headers['proxy-authorization'] && !self.tunnel) {\n    self.headers['proxy-authorization'] = \"Basic \" + toBase64(self.proxy.auth.split(':').map(function(item){ return querystring.unescape(item)}).join(':'))\n  }\n\n\n  if (self.proxy && !self.tunnel) self.path = (self.uri.protocol + '//' + self.uri.host + self.path)\n\n  if (options.json) {\n    self.json(options.json)\n  } else if (options.multipart) {\n    self.boundary = uuid()\n    self.multipart(options.multipart)\n  }\n\n  if (self.body) {\n    var length = 0\n    if (!Buffer.isBuffer(self.body)) {\n      if (Array.isArray(self.body)) {\n        for (var i = 0; i < self.body.length; i++) {\n          length += self.body[i].length\n        }\n      } else {\n        self.body = new Buffer(self.body)\n        length = self.body.length\n      }\n    } else {\n      length = self.body.length\n    }\n    if (length) {\n      if(!self.headers['content-length'] && !self.headers['Content-Length'])\n      self.headers['content-length'] = length\n    } else {\n      throw new Error('Argument error, options.body.')\n    }\n  }\n\n  var protocol = self.proxy && !self.tunnel ? self.proxy.protocol : self.uri.protocol\n    , defaultModules = {'http:':http, 'https:':https}\n    , httpModules = self.httpModules || {}\n    ;\n  self.httpModule = httpModules[protocol] || defaultModules[protocol]\n\n  if (!self.httpModule) return this.emit('error', new Error(\"Invalid protocol\"))\n\n  if (options.ca) self.ca = options.ca\n\n  if (!self.agent) {\n    if (options.agentOptions) self.agentOptions = options.agentOptions\n\n    if (options.agentClass) {\n      self.agentClass = options.agentClass\n    } else if (options.forever) {\n      self.agentClass = protocol === 'http:' ? ForeverAgent : ForeverAgent.SSL\n    } else {\n      self.agentClass = self.httpModule.Agent\n    }\n  }\n\n  if (self.pool === false) {\n    self.agent = false\n  } else {\n    self.agent = self.agent || self.getAgent()\n    if (self.maxSockets) {\n      // Don't use our pooling if node has the refactored client\n      self.agent.maxSockets = self.maxSockets\n    }\n    if (self.pool.maxSockets) {\n      // Don't use our pooling if node has the refactored client\n      self.agent.maxSockets = self.pool.maxSockets\n    }\n  }\n\n  self.once('pipe', function (src) {\n    if (self.ntick && self._started) throw new Error(\"You cannot pipe to this stream after the outbound request has started.\")\n    self.src = src\n    if (isReadStream(src)) {\n      if (!self.headers['content-type'] && !self.headers['Content-Type'])\n        self.headers['content-type'] = mime.lookup(src.path)\n    } else {\n      if (src.headers) {\n        for (var i in src.headers) {\n          if (!self.headers[i]) {\n            self.headers[i] = src.headers[i]\n          }\n        }\n      }\n      if (self._json && !self.headers['content-type'] && !self.headers['Content-Type'])\n        self.headers['content-type'] = 'application/json'\n      if (src.method && !self.explicitMethod) {\n        self.method = src.method\n      }\n    }\n\n    self.on('pipe', function () {\n      console.error(\"You have already piped to this stream. Pipeing twice is likely to break the request.\")\n    })\n  })\n\n  process.nextTick(function () {\n    if (self._aborted) return\n\n    if (self._form) {\n      self.setHeaders(self._form.getHeaders())\n      self._form.pipe(self)\n    }\n    if (self.body) {\n      if (Array.isArray(self.body)) {\n        self.body.forEach(function (part) {\n          self.write(part)\n        })\n      } else {\n        self.write(self.body)\n      }\n      self.end()\n    } else if (self.requestBodyStream) {\n      console.warn(\"options.requestBodyStream is deprecated, please pass the request object to stream.pipe.\")\n      self.requestBodyStream.pipe(self)\n    } else if (!self.src) {\n      if (self.method !== 'GET' && typeof self.method !== 'undefined') {\n        self.headers['content-length'] = 0\n      }\n      self.end()\n    }\n    self.ntick = true\n  })\n}\n\n// Must call this when following a redirect from https to http or vice versa\n// Attempts to keep everything as identical as possible, but update the\n// httpModule, Tunneling agent, and/or Forever Agent in use.\nRequest.prototype._updateProtocol = function () {\n  var self = this\n  var protocol = self.uri.protocol\n\n  if (protocol === 'https:') {\n    // previously was doing http, now doing https\n    // if it's https, then we might need to tunnel now.\n    if (self.proxy) {\n      self.tunnel = true\n      var tunnelFn = self.proxy.protocol === 'http:'\n                   ? tunnel.httpsOverHttp : tunnel.httpsOverHttps\n      var tunnelOptions = { proxy: { host: self.proxy.hostname\n                                   , port: +self.proxy.port\n                                   , proxyAuth: self.proxy.auth }\n                          , rejectUnauthorized: self.rejectUnauthorized\n                          , ca: self.ca }\n      self.agent = tunnelFn(tunnelOptions)\n      return\n    }\n\n    self.httpModule = https\n    switch (self.agentClass) {\n      case ForeverAgent:\n        self.agentClass = ForeverAgent.SSL\n        break\n      case http.Agent:\n        self.agentClass = https.Agent\n        break\n      default:\n        // nothing we can do.  Just hope for the best.\n        return\n    }\n\n    // if there's an agent, we need to get a new one.\n    if (self.agent) self.agent = self.getAgent()\n\n  } else {\n    // previously was doing https, now doing http\n    // stop any tunneling.\n    if (self.tunnel) self.tunnel = false\n    self.httpModule = http\n    switch (self.agentClass) {\n      case ForeverAgent.SSL:\n        self.agentClass = ForeverAgent\n        break\n      case https.Agent:\n        self.agentClass = http.Agent\n        break\n      default:\n        // nothing we can do.  just hope for the best\n        return\n    }\n\n    // if there's an agent, then get a new one.\n    if (self.agent) {\n      self.agent = null\n      self.agent = self.getAgent()\n    }\n  }\n}\n\nRequest.prototype.getAgent = function () {\n  var Agent = this.agentClass\n  var options = {}\n  if (this.agentOptions) {\n    for (var i in this.agentOptions) {\n      options[i] = this.agentOptions[i]\n    }\n  }\n  if (this.ca) options.ca = this.ca\n  if (typeof this.rejectUnauthorized !== 'undefined') options.rejectUnauthorized = this.rejectUnauthorized\n\n  if (this.cert && this.key) {\n    options.key = this.key\n    options.cert = this.cert\n  }\n\n  var poolKey = ''\n\n  // different types of agents are in different pools\n  if (Agent !== this.httpModule.Agent) {\n    poolKey += Agent.name\n  }\n\n  if (!this.httpModule.globalAgent) {\n    // node 0.4.x\n    options.host = this.host\n    options.port = this.port\n    if (poolKey) poolKey += ':'\n    poolKey += this.host + ':' + this.port\n  }\n\n  // ca option is only relevant if proxy or destination are https\n  var proxy = this.proxy\n  if (typeof proxy === 'string') proxy = url.parse(proxy)\n  var isHttps = (proxy && proxy.protocol === 'https:') || this.uri.protocol === 'https:'\n  if (isHttps) {\n    if (options.ca) {\n      if (poolKey) poolKey += ':'\n      poolKey += options.ca\n    }\n\n    if (typeof options.rejectUnauthorized !== 'undefined') {\n      if (poolKey) poolKey += ':'\n      poolKey += options.rejectUnauthorized\n    }\n\n    if (options.cert)\n      poolKey += options.cert.toString('ascii') + options.key.toString('ascii')\n  }\n\n  if (!poolKey && Agent === this.httpModule.Agent && this.httpModule.globalAgent) {\n    // not doing anything special.  Use the globalAgent\n    return this.httpModule.globalAgent\n  }\n\n  // we're using a stored agent.  Make sure it's protocol-specific\n  poolKey = this.uri.protocol + poolKey\n\n  // already generated an agent for this setting\n  if (this.pool[poolKey]) return this.pool[poolKey]\n\n  return this.pool[poolKey] = new Agent(options)\n}\n\nRequest.prototype.start = function () {\n  // start() is called once we are ready to send the outgoing HTTP request.\n  // this is usually called on the first write(), end() or on nextTick()\n  var self = this\n\n  if (self._aborted) return\n\n  self._started = true\n  self.method = self.method || 'GET'\n  self.href = self.uri.href\n\n  if (self.src && self.src.stat && self.src.stat.size && !self.headers['content-length'] && !self.headers['Content-Length']) {\n    self.headers['content-length'] = self.src.stat.size\n  }\n  if (self._aws) {\n    self.aws(self._aws, true)\n  }\n\n  // We have a method named auth, which is completely different from the http.request\n  // auth option.  If we don't remove it, we're gonna have a bad time.\n  var reqOptions = copy(self)\n  delete reqOptions.auth\n\n  debug('make request', self.uri.href)\n  self.req = self.httpModule.request(reqOptions, self.onResponse.bind(self))\n\n  if (self.timeout && !self.timeoutTimer) {\n    self.timeoutTimer = setTimeout(function () {\n      self.req.abort()\n      var e = new Error(\"ETIMEDOUT\")\n      e.code = \"ETIMEDOUT\"\n      self.emit(\"error\", e)\n    }, self.timeout)\n\n    // Set additional timeout on socket - in case if remote\n    // server freeze after sending headers\n    if (self.req.setTimeout) { // only works on node 0.6+\n      self.req.setTimeout(self.timeout, function () {\n        if (self.req) {\n          self.req.abort()\n          var e = new Error(\"ESOCKETTIMEDOUT\")\n          e.code = \"ESOCKETTIMEDOUT\"\n          self.emit(\"error\", e)\n        }\n      })\n    }\n  }\n\n  self.req.on('error', self.clientErrorHandler)\n  self.req.on('drain', function() {\n    self.emit('drain')\n  })\n  self.on('end', function() {\n    if ( self.req.connection ) self.req.connection.removeListener('error', self._parserErrorHandler)\n  })\n  self.emit('request', self.req)\n}\nRequest.prototype.onResponse = function (response) {\n  var self = this\n  debug('onResponse', self.uri.href, response.statusCode, response.headers)\n  response.on('end', function() {\n    debug('response end', self.uri.href, response.statusCode, response.headers)\n  });\n\n  if (response.connection.listeners('error').indexOf(self._parserErrorHandler) === -1) {\n    response.connection.once('error', self._parserErrorHandler)\n  }\n  if (self._aborted) {\n    debug('aborted', self.uri.href)\n    response.resume()\n    return\n  }\n  if (self._paused) response.pause()\n  else response.resume()\n\n  self.response = response\n  response.request = self\n  response.toJSON = toJSON\n\n  // XXX This is different on 0.10, because SSL is strict by default\n  if (self.httpModule === https &&\n      self.strictSSL &&\n      !response.client.authorized) {\n    debug('strict ssl error', self.uri.href)\n    var sslErr = response.client.authorizationError\n    self.emit('error', new Error('SSL Error: '+ sslErr))\n    return\n  }\n\n  if (self.setHost) delete self.headers.host\n  if (self.timeout && self.timeoutTimer) {\n    clearTimeout(self.timeoutTimer)\n    self.timeoutTimer = null\n  }\n\n  var addCookie = function (cookie) {\n    if (self._jar) self._jar.add(new Cookie(cookie))\n    else cookieJar.add(new Cookie(cookie))\n  }\n\n  if (response.headers['set-cookie'] && (!self._disableCookies)) {\n    if (Array.isArray(response.headers['set-cookie'])) response.headers['set-cookie'].forEach(addCookie)\n    else addCookie(response.headers['set-cookie'])\n  }\n\n  var redirectTo = null\n  if (response.statusCode >= 300 && response.statusCode < 400 && response.headers.location) {\n    debug('redirect', response.headers.location)\n\n    if (self.followAllRedirects) {\n      redirectTo = response.headers.location\n    } else if (self.followRedirect) {\n      switch (self.method) {\n        case 'PATCH':\n        case 'PUT':\n        case 'POST':\n        case 'DELETE':\n          // Do not follow redirects\n          break\n        default:\n          redirectTo = response.headers.location\n          break\n      }\n    }\n  } else if (response.statusCode == 401 && self._hasAuth && !self._sentAuth) {\n    var authHeader = response.headers['www-authenticate']\n    var authVerb = authHeader && authHeader.split(' ')[0]\n    debug('reauth', authVerb)\n\n    switch (authVerb) {\n      case 'Basic':\n        self.auth(self._user, self._pass, true)\n        redirectTo = self.uri\n        break\n\n      case 'Digest':\n        // TODO: More complete implementation of RFC 2617.  For reference:\n        // http://tools.ietf.org/html/rfc2617#section-3\n        // https://github.com/bagder/curl/blob/master/lib/http_digest.c\n\n        var matches = authHeader.match(/([a-z0-9_-]+)=\"([^\"]+)\"/gi)\n        var challenge = {}\n\n        for (var i = 0; i < matches.length; i++) {\n          var eqPos = matches[i].indexOf('=')\n          var key = matches[i].substring(0, eqPos)\n          var quotedValue = matches[i].substring(eqPos + 1)\n          challenge[key] = quotedValue.substring(1, quotedValue.length - 1)\n        }\n\n        var ha1 = md5(self._user + ':' + challenge.realm + ':' + self._pass)\n        var ha2 = md5(self.method + ':' + self.uri.path)\n        var digestResponse = md5(ha1 + ':' + challenge.nonce + ':1::auth:' + ha2)\n        var authValues = {\n          username: self._user,\n          realm: challenge.realm,\n          nonce: challenge.nonce,\n          uri: self.uri.path,\n          qop: challenge.qop,\n          response: digestResponse,\n          nc: 1,\n          cnonce: ''\n        }\n\n        authHeader = []\n        for (var k in authValues) {\n          authHeader.push(k + '=\"' + authValues[k] + '\"')\n        }\n        authHeader = 'Digest ' + authHeader.join(', ')\n        self.setHeader('authorization', authHeader)\n        self._sentAuth = true\n\n        redirectTo = self.uri\n        break\n    }\n  }\n\n  if (redirectTo) {\n    debug('redirect to', redirectTo)\n\n    // ignore any potential response body.  it cannot possibly be useful\n    // to us at this point.\n    if (self._paused) response.resume()\n\n    if (self._redirectsFollowed >= self.maxRedirects) {\n      self.emit('error', new Error(\"Exceeded maxRedirects. Probably stuck in a redirect loop \"+self.uri.href))\n      return\n    }\n    self._redirectsFollowed += 1\n\n    if (!isUrl.test(redirectTo)) {\n      redirectTo = url.resolve(self.uri.href, redirectTo)\n    }\n\n    var uriPrev = self.uri\n    self.uri = url.parse(redirectTo)\n\n    // handle the case where we change protocol from https to http or vice versa\n    if (self.uri.protocol !== uriPrev.protocol) {\n      self._updateProtocol()\n    }\n\n    self.redirects.push(\n      { statusCode : response.statusCode\n      , redirectUri: redirectTo\n      }\n    )\n    if (self.followAllRedirects && response.statusCode != 401) self.method = 'GET'\n    // self.method = 'GET' // Force all redirects to use GET || commented out fixes #215\n    delete self.src\n    delete self.req\n    delete self.agent\n    delete self._started\n    if (response.statusCode != 401) {\n      // Remove parameters from the previous response, unless this is the second request\n      // for a server that requires digest authentication.\n      delete self.body\n      delete self._form\n      if (self.headers) {\n        delete self.headers.host\n        delete self.headers['content-type']\n        delete self.headers['content-length']\n      }\n    }\n\n    self.emit('redirect');\n\n    self.init()\n    return // Ignore the rest of the response\n  } else {\n    self._redirectsFollowed = self._redirectsFollowed || 0\n    // Be a good stream and emit end when the response is finished.\n    // Hack to emit end on close because of a core bug that never fires end\n    response.on('close', function () {\n      if (!self._ended) self.response.emit('end')\n    })\n\n    if (self.encoding) {\n      if (self.dests.length !== 0) {\n        console.error(\"Ingoring encoding parameter as this stream is being piped to another stream which makes the encoding option invalid.\")\n      } else {\n        response.setEncoding(self.encoding)\n      }\n    }\n\n    self.emit('response', response)\n\n    self.dests.forEach(function (dest) {\n      self.pipeDest(dest)\n    })\n\n    response.on(\"data\", function (chunk) {\n      self._destdata = true\n      self.emit(\"data\", chunk)\n    })\n    response.on(\"end\", function (chunk) {\n      self._ended = true\n      self.emit(\"end\", chunk)\n    })\n    response.on(\"close\", function () {self.emit(\"close\")})\n\n    if (self.callback) {\n      var buffer = []\n      var bodyLen = 0\n      self.on(\"data\", function (chunk) {\n        buffer.push(chunk)\n        bodyLen += chunk.length\n      })\n      self.on(\"end\", function () {\n        debug('end event', self.uri.href)\n        if (self._aborted) {\n          debug('aborted', self.uri.href)\n          return\n        }\n\n        if (buffer.length && Buffer.isBuffer(buffer[0])) {\n          debug('has body', self.uri.href, bodyLen)\n          var body = new Buffer(bodyLen)\n          var i = 0\n          buffer.forEach(function (chunk) {\n            chunk.copy(body, i, 0, chunk.length)\n            i += chunk.length\n          })\n          if (self.encoding === null) {\n            response.body = body\n          } else {\n            response.body = body.toString(self.encoding)\n          }\n        } else if (buffer.length) {\n          // The UTF8 BOM [0xEF,0xBB,0xBF] is converted to [0xFE,0xFF] in the JS UTC16/UCS2 representation.\n          // Strip this value out when the encoding is set to 'utf8', as upstream consumers won't expect it and it breaks JSON.parse().\n          if (self.encoding === 'utf8' && buffer[0].length > 0 && buffer[0][0] === \"\\uFEFF\") {\n            buffer[0] = buffer[0].substring(1)\n          }\n          response.body = buffer.join('')\n        }\n\n        if (self._json) {\n          try {\n            response.body = JSON.parse(response.body)\n          } catch (e) {}\n        }\n        debug('emitting complete', self.uri.href)\n        if(response.body == undefined && !self._json) {\n          response.body = \"\";\n        }\n        self.emit('complete', response, response.body)\n      })\n    }\n  }\n  debug('finish init function', self.uri.href)\n}\n\nRequest.prototype.abort = function () {\n  this._aborted = true\n\n  if (this.req) {\n    this.req.abort()\n  }\n  else if (this.response) {\n    this.response.abort()\n  }\n\n  this.emit(\"abort\")\n}\n\nRequest.prototype.pipeDest = function (dest) {\n  var response = this.response\n  // Called after the response is received\n  if (dest.headers) {\n    dest.headers['content-type'] = response.headers['content-type']\n    if (response.headers['content-length']) {\n      dest.headers['content-length'] = response.headers['content-length']\n    }\n  }\n  if (dest.setHeader) {\n    for (var i in response.headers) {\n      dest.setHeader(i, response.headers[i])\n    }\n    dest.statusCode = response.statusCode\n  }\n  if (this.pipefilter) this.pipefilter(response, dest)\n}\n\n// Composable API\nRequest.prototype.setHeader = function (name, value, clobber) {\n  if (clobber === undefined) clobber = true\n  if (clobber || !this.headers.hasOwnProperty(name)) this.headers[name] = value\n  else this.headers[name] += ',' + value\n  return this\n}\nRequest.prototype.setHeaders = function (headers) {\n  for (var i in headers) {this.setHeader(i, headers[i])}\n  return this\n}\nRequest.prototype.qs = function (q, clobber) {\n  var base\n  if (!clobber && this.uri.query) base = qs.parse(this.uri.query)\n  else base = {}\n\n  for (var i in q) {\n    base[i] = q[i]\n  }\n\n  if (qs.stringify(base) === ''){\n    return this\n  }\n\n  this.uri = url.parse(this.uri.href.split('?')[0] + '?' + qs.stringify(base))\n  this.url = this.uri\n  this.path = this.uri.path\n\n  return this\n}\nRequest.prototype.form = function (form) {\n  if (form) {\n    this.headers['content-type'] = 'application/x-www-form-urlencoded; charset=utf-8'\n    this.body = qs.stringify(form).toString('utf8')\n    return this\n  }\n  // create form-data object\n  this._form = new FormData()\n  return this._form\n}\nRequest.prototype.multipart = function (multipart) {\n  var self = this\n  self.body = []\n\n  if (!self.headers['content-type']) {\n    self.headers['content-type'] = 'multipart/related; boundary=' + self.boundary\n  } else {\n    self.headers['content-type'] = self.headers['content-type'].split(';')[0] + '; boundary=' + self.boundary\n  }\n\n  if (!multipart.forEach) throw new Error('Argument error, options.multipart.')\n\n  if (self.preambleCRLF) {\n    self.body.push(new Buffer('\\r\\n'))\n  }\n\n  multipart.forEach(function (part) {\n    var body = part.body\n    if(body == null) throw Error('Body attribute missing in multipart.')\n    delete part.body\n    var preamble = '--' + self.boundary + '\\r\\n'\n    Object.keys(part).forEach(function (key) {\n      preamble += key + ': ' + part[key] + '\\r\\n'\n    })\n    preamble += '\\r\\n'\n    self.body.push(new Buffer(preamble))\n    self.body.push(new Buffer(body))\n    self.body.push(new Buffer('\\r\\n'))\n  })\n  self.body.push(new Buffer('--' + self.boundary + '--'))\n  return self\n}\nRequest.prototype.json = function (val) {\n  var self = this;\n  var setAcceptHeader = function() {\n  \tif (!self.headers['accept'] && !self.headers['Accept']) {\n\t\t\t  self.setHeader('accept', 'application/json')\n\t\t}\n\t}\n  setAcceptHeader();\n  this._json = true\n  if (typeof val === 'boolean') {\n    if (typeof this.body === 'object') {\n      setAcceptHeader();\n      this.body = safeStringify(this.body)\n      self.setHeader('content-type', 'application/json')\n    }\n  } else {\n    setAcceptHeader();\n    this.body = safeStringify(val)\n    self.setHeader('content-type', 'application/json')\n  }\n  return this\n}\nfunction getHeader(name, headers) {\n    var result, re, match\n    Object.keys(headers).forEach(function (key) {\n        re = new RegExp(name, 'i')\n        match = key.match(re)\n        if (match) result = headers[key]\n    })\n    return result\n}\nRequest.prototype.auth = function (user, pass, sendImmediately) {\n  if (typeof user !== 'string' || (pass !== undefined && typeof pass !== 'string')) {\n    throw new Error('auth() received invalid user or password')\n  }\n  this._user = user\n  this._pass = pass\n  this._hasAuth = true\n  if (sendImmediately || typeof sendImmediately == 'undefined') {\n    this.setHeader('authorization', 'Basic ' + toBase64(user + ':' + pass))\n    this._sentAuth = true\n  }\n  return this\n}\nRequest.prototype.aws = function (opts, now) {\n  if (!now) {\n    this._aws = opts\n    return this\n  }\n  var date = new Date()\n  this.setHeader('date', date.toUTCString())\n  var auth =\n    { key: opts.key\n    , secret: opts.secret\n    , verb: this.method.toUpperCase()\n    , date: date\n    , contentType: getHeader('content-type', this.headers) || ''\n    , md5: getHeader('content-md5', this.headers) || ''\n    , amazonHeaders: aws.canonicalizeHeaders(this.headers)\n    }\n  if (opts.bucket && this.path) {\n    auth.resource = '/' + opts.bucket + this.path\n  } else if (opts.bucket && !this.path) {\n    auth.resource = '/' + opts.bucket\n  } else if (!opts.bucket && this.path) {\n    auth.resource = this.path\n  } else if (!opts.bucket && !this.path) {\n    auth.resource = '/'\n  }\n  auth.resource = aws.canonicalizeResource(auth.resource)\n  this.setHeader('authorization', aws.authorization(auth))\n\n  return this\n}\nRequest.prototype.httpSignature = function (opts) {\n  var req = this\n  httpSignature.signRequest({\n    getHeader: function(header) {\n      return getHeader(header, req.headers)\n    },\n    setHeader: function(header, value) {\n      req.setHeader(header, value)\n    },\n    method: this.method,\n    path: this.path\n  }, opts)\n  debug('httpSignature authorization', getHeader('authorization', this.headers))\n\n  return this\n}\n\nRequest.prototype.hawk = function (opts) {\n  this.headers.Authorization = hawk.client.header(this.uri, this.method, opts).field\n}\n\nRequest.prototype.oauth = function (_oauth) {\n  var form\n  if (this.headers['content-type'] &&\n      this.headers['content-type'].slice(0, 'application/x-www-form-urlencoded'.length) ===\n        'application/x-www-form-urlencoded'\n     ) {\n    form = qs.parse(this.body)\n  }\n  if (this.uri.query) {\n    form = qs.parse(this.uri.query)\n  }\n  if (!form) form = {}\n  var oa = {}\n  for (var i in form) oa[i] = form[i]\n  for (var i in _oauth) oa['oauth_'+i] = _oauth[i]\n  if (!oa.oauth_version) oa.oauth_version = '1.0'\n  if (!oa.oauth_timestamp) oa.oauth_timestamp = Math.floor( Date.now() / 1000 ).toString()\n  if (!oa.oauth_nonce) oa.oauth_nonce = uuid().replace(/-/g, '')\n\n  oa.oauth_signature_method = 'HMAC-SHA1'\n\n  var consumer_secret = oa.oauth_consumer_secret\n  delete oa.oauth_consumer_secret\n  var token_secret = oa.oauth_token_secret\n  delete oa.oauth_token_secret\n  var timestamp = oa.oauth_timestamp\n\n  var baseurl = this.uri.protocol + '//' + this.uri.host + this.uri.pathname\n  var signature = oauth.hmacsign(this.method, baseurl, oa, consumer_secret, token_secret)\n\n  // oa.oauth_signature = signature\n  for (var i in form) {\n    if ( i.slice(0, 'oauth_') in _oauth) {\n      // skip\n    } else {\n      delete oa['oauth_'+i]\n      if (i !== 'x_auth_mode') delete oa[i]\n    }\n  }\n  oa.oauth_timestamp = timestamp\n  this.headers.Authorization =\n    'OAuth '+Object.keys(oa).sort().map(function (i) {return i+'=\"'+oauth.rfc3986(oa[i])+'\"'}).join(',')\n  this.headers.Authorization += ',oauth_signature=\"' + oauth.rfc3986(signature) + '\"'\n  return this\n}\nRequest.prototype.jar = function (jar) {\n  var cookies\n\n  if (this._redirectsFollowed === 0) {\n    this.originalCookieHeader = this.headers.cookie\n  }\n\n  if (jar === false) {\n    // disable cookies\n    cookies = false\n    this._disableCookies = true\n  } else if (jar) {\n    // fetch cookie from the user defined cookie jar\n    cookies = jar.get({ url: this.uri.href })\n  } else {\n    // fetch cookie from the global cookie jar\n    cookies = cookieJar.get({ url: this.uri.href })\n  }\n\n  if (cookies && cookies.length) {\n    var cookieString = cookies.map(function (c) {\n      return c.name + \"=\" + c.value\n    }).join(\"; \")\n\n    if (this.originalCookieHeader) {\n      // Don't overwrite existing Cookie header\n      this.headers.cookie = this.originalCookieHeader + '; ' + cookieString\n    } else {\n      this.headers.cookie = cookieString\n    }\n  }\n  this._jar = jar\n  return this\n}\n\n\n// Stream API\nRequest.prototype.pipe = function (dest, opts) {\n  if (this.response) {\n    if (this._destdata) {\n      throw new Error(\"You cannot pipe after data has been emitted from the response.\")\n    } else if (this._ended) {\n      throw new Error(\"You cannot pipe after the response has been ended.\")\n    } else {\n      stream.Stream.prototype.pipe.call(this, dest, opts)\n      this.pipeDest(dest)\n      return dest\n    }\n  } else {\n    this.dests.push(dest)\n    stream.Stream.prototype.pipe.call(this, dest, opts)\n    return dest\n  }\n}\nRequest.prototype.write = function () {\n  if (!this._started) this.start()\n  return this.req.write.apply(this.req, arguments)\n}\nRequest.prototype.end = function (chunk) {\n  if (chunk) this.write(chunk)\n  if (!this._started) this.start()\n  this.req.end()\n}\nRequest.prototype.pause = function () {\n  if (!this.response) this._paused = true\n  else this.response.pause.apply(this.response, arguments)\n}\nRequest.prototype.resume = function () {\n  if (!this.response) this._paused = false\n  else this.response.resume.apply(this.response, arguments)\n}\nRequest.prototype.destroy = function () {\n  if (!this._ended) this.end()\n  else if (this.response) this.response.destroy()\n}\n\n// organize params for patch, post, put, head, del\nfunction initParams(uri, options, callback) {\n  if ((typeof options === 'function') && !callback) callback = options\n  if (options && typeof options === 'object') {\n    options.uri = uri\n  } else if (typeof uri === 'string') {\n    options = {uri:uri}\n  } else {\n    options = uri\n    uri = options.uri\n  }\n  return { uri: uri, options: options, callback: callback }\n}\n\nfunction request (uri, options, callback) {\n  if (typeof uri === 'undefined') throw new Error('undefined is not a valid uri or options object.')\n  if ((typeof options === 'function') && !callback) callback = options\n  if (options && typeof options === 'object') {\n    options.uri = uri\n  } else if (typeof uri === 'string') {\n    options = {uri:uri}\n  } else {\n    options = uri\n  }\n\n  options = copy(options)\n\n  if (callback) options.callback = callback\n  var r = new Request(options)\n  return r\n}\n\nmodule.exports = request\n\nrequest.debug = process.env.NODE_DEBUG && /request/.test(process.env.NODE_DEBUG)\n\nrequest.initParams = initParams\n\nrequest.defaults = function (options, requester) {\n  var def = function (method) {\n    var d = function (uri, opts, callback) {\n      var params = initParams(uri, opts, callback)\n      for (var i in options) {\n        if (params.options[i] === undefined) params.options[i] = options[i]\n      }\n      if(typeof requester === 'function') {\n        if(method === request) {\n          method = requester\n        } else {\n          params.options._requester = requester\n        }\n      }\n      return method(params.options, params.callback)\n    }\n    return d\n  }\n  var de = def(request)\n  de.get = def(request.get)\n  de.patch = def(request.patch)\n  de.post = def(request.post)\n  de.put = def(request.put)\n  de.head = def(request.head)\n  de.del = def(request.del)\n  de.cookie = def(request.cookie)\n  de.jar = request.jar\n  return de\n}\n\nrequest.forever = function (agentOptions, optionsArg) {\n  var options = {}\n  if (optionsArg) {\n    for (option in optionsArg) {\n      options[option] = optionsArg[option]\n    }\n  }\n  if (agentOptions) options.agentOptions = agentOptions\n  options.forever = true\n  return request.defaults(options)\n}\n\nrequest.get = request\nrequest.post = function (uri, options, callback) {\n  var params = initParams(uri, options, callback)\n  params.options.method = 'POST'\n  return request(params.uri || null, params.options, params.callback)\n}\nrequest.put = function (uri, options, callback) {\n  var params = initParams(uri, options, callback)\n  params.options.method = 'PUT'\n  return request(params.uri || null, params.options, params.callback)\n}\nrequest.patch = function (uri, options, callback) {\n  var params = initParams(uri, options, callback)\n  params.options.method = 'PATCH'\n  return request(params.uri || null, params.options, params.callback)\n}\nrequest.head = function (uri, options, callback) {\n  var params = initParams(uri, options, callback)\n  params.options.method = 'HEAD'\n  if (params.options.body ||\n      params.options.requestBodyStream ||\n      (params.options.json && typeof params.options.json !== 'boolean') ||\n      params.options.multipart) {\n    throw new Error(\"HTTP HEAD requests MUST NOT include a request body.\")\n  }\n  return request(params.uri || null, params.options, params.callback)\n}\nrequest.del = function (uri, options, callback) {\n  var params = initParams(uri, options, callback)\n  params.options.method = 'DELETE'\n  if(typeof params.options._requester === 'function') {\n    request = params.options._requester\n  }\n  return request(params.uri || null, params.options, params.callback)\n}\nrequest.jar = function () {\n  return new CookieJar\n}\nrequest.cookie = function (str) {\n  if (str && str.uri) str = str.uri\n  if (typeof str !== 'string') throw new Error(\"The cookie function only accepts STRING as param\")\n  return new Cookie(str)\n}\n\n// Safe toJSON\n\nfunction getSafe (self, uuid) {\n  if (typeof self === 'object' || typeof self === 'function') var safe = {}\n  if (Array.isArray(self)) var safe = []\n\n  var recurse = []\n\n  Object.defineProperty(self, uuid, {})\n\n  var attrs = Object.keys(self).filter(function (i) {\n    if (i === uuid) return false\n    if ( (typeof self[i] !== 'object' && typeof self[i] !== 'function') || self[i] === null) return true\n    return !(Object.getOwnPropertyDescriptor(self[i], uuid))\n  })\n\n\n  for (var i=0;i<attrs.length;i++) {\n    if ( (typeof self[attrs[i]] !== 'object' && typeof self[attrs[i]] !== 'function') ||\n          self[attrs[i]] === null\n        ) {\n      safe[attrs[i]] = self[attrs[i]]\n    } else {\n      recurse.push(attrs[i])\n      Object.defineProperty(self[attrs[i]], uuid, {})\n    }\n  }\n\n  for (var i=0;i<recurse.length;i++) {\n    safe[recurse[i]] = getSafe(self[recurse[i]], uuid)\n  }\n\n  return safe\n}\n\nfunction toJSON () {\n  return getSafe(this, '__' + (((1+Math.random())*0x10000)|0).toString(16))\n}\n\nRequest.prototype.toJSON = toJSON\n"]},"metadata":{},"sourceType":"script"}